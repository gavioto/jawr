<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">










<html>
  <head>
    <title>Jawr - Integrating Jawr in a framework</title>
    <style type="text/css" media="all">
      @import url("../css/maven-base.css");
      @import url("../css/maven-theme.css");
      @import url("../css/site.css");
    </style>
    <link rel="stylesheet" href="../css/print.css" type="text/css" media="print" />
        <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />
      </head>
  <body class="composite">
    <!-- TODO: move this into JavaScript to patch the skin
      <div class="xright">  </div>
    -->
    <div id="leftColumn">
      <div id="navcolumn">
             <dl class=navgroup>
        <dt>About</dt>
        <dd><ul>
              
    <li class="none">
              <a href="../servlets/ProjectHome">Home</a>
        </li>
              
    <li class="none">
              <a href="../introduction.html">Introduction</a>
        </li>
              
    <li class="none">
              <a href="../features.html">Features</a>
        </li>
              
    <li class="none">
              <a href="../changes.html">Change history</a>
        </li>
              
    <li class="none">
              <a href="../team.html">The team</a>
        </li>
          </ul></dd>
    </dl>
      <dl class=navgroup>
        <dt>Documentation</dt>
        <dd><ul>
              
    <li class="none">
              <a href="../docs/servlet.html">The Jawr servlet</a>
        </li>
              
    <li class="none">
              <a href="../docs/descriptor_syntax.html">Descriptor syntax</a>
        </li>
              
    <li class="none">
              <a href="../docs/custom_bundles.html">Bundle definition</a>
        </li>
              
    <li class="none">
              <a href="../docs/source_ordering.html">Source order in bundles</a>
        </li>
              
    <li class="none">
              <a href="../docs/postprocessors.html">Postprocessors</a>
        </li>
              
    <li class="none">
              <a href="../docs/generators.html">Generators</a>
        </li>
              
    <li class="none">
              <a href="../docs/license_files.html">Licenses in resources</a>
        </li>
              
    <li class="none">
              <a href="../docs/taglibs.html">JSP Tag library</a>
        </li>
              
    <li class="none">
              <a href="../docs/plain_html.html">Use in HTML pages</a>
        </li>
              
    <li class="none">
              <a href="../docs/modes.html">Debug and production modes</a>
        </li>
              
    <li class="none">
              <a href="../docs/messages_gen.html">i18n message generator</a>
        </li>
              
    <li class="none">
              <a href="../docs/jmx_support_gen.html">JMX Support</a>
        </li>
              
    <li class="none">
              <a href="../docs/bundle_preprocessing_gen.html">Bundle preprocessing</a>
        </li>
              
    <li class="none">
              <a href="../docs/jawr_maven_plugin_gen.html">Jawr Maven plugin</a>
        </li>
              
    <li class="none">
              <a href="../docs/jawr_ant_task_gen.html">Jawr Ant task</a>
        </li>
          </ul></dd>
    </dl>
      <dl class=navgroup>
        <dt>Integration</dt>
        <dd><ul>
              
    <li class="none">
              <strong>Add Jawr to your framework</strong>
        </li>
              
    <li class="none">
              <a href="../integration/spring.html">Spring MVC</a>
        </li>
              
    <li class="none">
              <a href="../integration/facelets.html">Facelets Tag library</a>
        </li>
              
    <li class="none">
              <a href="../integration/grails.html">Grails plugin</a>
        </li>
              
    <li class="none">
              <a href="../integration/dwr.html">DWR</a>
        </li>
              
    <li class="none">
              <a href="../integration/validator.html">Commons Validator - Struts</a>
        </li>
          </ul></dd>
    </dl>
      <dl class=navgroup>
        <dt>Tutorials</dt>
        <dd><ul>
              
    <li class="none">
              <a href="../tutorials/quickstart.html">Quick start</a>
        </li>
              
    <li class="none">
              <a href="../tutorials/faq_howto.html">FAQ-Howto</a>
        </li>
              
    <li class="none">
              <a href="../tutorials/libraries.html">Using popular libraries</a>
        </li>
          </ul></dd>
    </dl>
      <dl class=navgroup>
        <dt>API and sources</dt>
        <dd><ul>
              
    <li class="none">
              <a href="../nonav/apidocs/index.html">JavaDocs</a>
        </li>
              
    <li class="none">
              <a href="../nonav/xref/index.html">Source XREF</a>
        </li>
          </ul></dd>
    </dl>
      <dl class=navgroup>
        <dt>Project tools</dt>
        <dd><ul>
              
    <li class="none">
              <a href="../servlets/ProjectHome">Project home</a>
        </li>
              
    <li class="none">
              <a href="../servlets/ProjectMemberList">Membership</a>
        </li>
              
    <li class="none">
              <a href="../servlets/ProjectNewsList">Announcements</a>
        </li>
              
    <li class="none">
              <a href="../servlets/ProjectForumView">Discussion forums</a>
        </li>
              
    <li class="none">
              <a href="../servlets/ProjectMailingListList">Mailing lists</a>
        </li>
              
    <li class="none">
              <a href="../servlets/ProjectDocumentList">Documents & files</a>
        </li>
              
    <li class="none">
              <a href="../source/browse/jawr/">Subversion</a>
        </li>
              
    <li class="none">
              <a href="../servlets/ProjectIssues">Issue tracker</a>
        </li>
          </ul></dd>
    </dl>
        </div>
      <script>
        // replace the java.net project tools with the navigation bar from Maven.
        // also get rid of "Get Involved" thingie too, while we are at it
        var pt = document.getElementById("projecttools");
        var nv = document.getElementById("navcolumn");
        
        while(pt.previousSibling!=null)
          pt.parentNode.removeChild(pt.previousSibling);
        
        pt.parentNode.insertBefore(nv,pt);
        pt.parentNode.removeChild(pt);
      </script>
      <script>
        // kill "description" h3 bar
        var ld = document.getElementById("longdescription");
        if(ld!=null) {
          for( n=ld.firstChild; n!=null; n=n.nextSibling ) {
            if(n.nodeType==1 && n.innerHTML=="Description" ) {
              n.parentNode.removeChild(n);
              break;
            }
          }
        }
      </script>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <div class="section"><h2>Integrating Jawr in a framework</h2>
<p>Jawr lends itself to integrating in web frameworks of wider scope. If you have one and want to use Jawr, you probably will want your users to benefit from it instead of just using it for your framework's needs. </p>
<p>This means that you will probably use Jawr to bundle scripts and CSS to enhance performance. But your framework's users will probably benefit from using Jawr to bundle and compress their resources with Jawr. Better yet, they could augment the bundles that come with your framework for the tightest integration and lowest response times for pages. </p>
<p>In order to achieve this, Jawr has some hooks to provide multiple configuration files that augment each other. The idea behind this is that you will provide with a base configuration, which defines several standard bundles. Then you provide configuration hooks to add additional config files, in which users define their own bundles and also augment those in your framework. </p>
<p>Two components help in achieving this functionality: <b>ConfigPropertiesAugmenter</b> and <b>MultipleFileConfigSource</b>. The latter is a pre-cooked implementation of the ConfigPropertiesSource interface which you can extend to easily get up and running with this configuration scheme. ConfigPropertiesAugmenter is a lower level component that you can use if extending MultipleFileConfigSource does not suit your needs.</p>
<p>In some cases, you might want to create your own system to render the links and script tags in HTML pages, instead of using the included tag libraries from Jawr. It is actually rather easy to accomplish this, if you follow the instructions at the bottom of this page. </p>
<div class="section"><h3>Extending MultipleFileConfigSource</h3>
<p>This class loads a configuration file in the usual Jawr way (i.e., loads the config file specified in the configLocation init-param), and then loads further configuration files which augment the base configuration. By default, the additional configuration properties are defined as a parameter in the servlet context, under the key 'jawr.config.sources'. In the web.xml, configuration would be defined as follows: </p>
<div class="source"><pre>        &lt;context-param&gt;
                &lt;param-name&gt;jawr.config.sources&lt;/param-name&gt;
                &lt;param-value&gt;file:C:\jawr_A.properties,file:C:\jawr_B.properties&lt;/param-value&gt;
        &lt;/context-param&gt;</pre>
</div>
<p>Of course, this is not the best way to achieve this ends. You framework will probably have better ways to configure this parameter, so all you need to do is to extend MultipleFileConfigSource and to override the method that retrieves the parameter value, which has the following signature: </p>
<div class="source"><pre>        protected void initAdditionalPropertyBaseNames(ServletContext context); </pre>
</div>
<p>This method should initialize a property named 'propertyBaseNames' (which is a List object), and add to it the names of the properties files which should override the base configuration. Optionally, you can also initialize another object, this time a Set, named 'privateConfigProperties', and add all the names of properties that you don't wish to let users change or augment. </p>
<p>Once this is done, you only need to register your object as the ConfigPropertiesSource for Jawr, so it will be used instead of the default one. Normally it is done through the servlet configuration: </p>
<div class="source"><pre>                &lt;init-param&gt;
                        &lt;param-name&gt;configPropertiesSourceClass&lt;/param-name&gt;
                        &lt;param-value&gt;org.myframework.MyConfigPropertiesImplementation&lt;/param-value&gt;
                &lt;/init-param&gt;</pre>
</div>
<p>The benefit of overriding MultipleFileConfigSource is that the automatic reloading of configuration will work out of the box. Users will be able to set the time interval to check for changes in the configuration and have Jawr reload whenever changes are made. Also, the syntax to specify the location of config files remains the same as usual (using 'file:' as a prefix to load from the filesystem, or no prefix to load from the classpath). </p>
</div>
<div class="section"><h3>Using ConfigPropertiesAugmenter </h3>
<p>Normally, you will not need to use this class directly (being much better to override MultipleFileConfigSource), but it's important to know its behavior to understand how config augmentation works. So, read on even if you don't plan on using it. This class has two constructors: </p>
<div class="source"><pre>public ConfigPropertiesAugmenter(Properties configProperties);
public ConfigPropertiesAugmenter(Properties configProperties,Set privateConfigProperties);</pre>
</div>
<p>Both get the base Properties to later augment, and in the second case, a Set of 'private' config properties. This set contains names of configuration properties which will not be overwritten or augmented. For instance, if you do not wish to allow users to change the encoding of bundles (which is probably a good idea), you would add 'jawr.charset.name' to this Set. </p>
<p>The method which augments configuration is this one: </p>
<div class="source"><pre>         public void augmentConfiguration(Properties configToAdd); </pre>
</div>
<p>This method will get all properties in configToAdd and overwrite those in the base configuration, <i>except</i> for those which are augmentable. Augmentable properties will be <i>extended</i>. Take for instance a mapping property such as this: </p>
<div class="source"><pre>         jawr.js.bundle.one.mappings=/js/someFile.js, /js/someOtherFile.js</pre>
</div>
<p>Now, in an additional Properties file we have this mapping: </p>
<div class="source"><pre>         jawr.js.bundle.one.mappings=/javascript/userProvidedScript.js</pre>
</div>
<p>Well, after augmentation, the final configuration would look like this: </p>
<div class="source"><pre>         jawr.js.bundle.one.mappings=/js/someFile.js, /js/someOtherFile.js, /javascript/userProvidedScript.js</pre>
</div>
<p>In this example the user augments the mappings of a framework-provided bundle with his own content, thus reduceing the total number of required downloads to access his application. </p>
<p>The augmentable properties are the following: </p>
<ul><li>Bundle definitions (jawr.[type].bundle.names). Note this property is deprecated as of version 2.7, but you can't mix configurations with and without it, so be sure to make it clear wether it should be used or not when letting others augment your configuration. </li>
<li>Bundle mappings (jawr.[type].bundle.[name].mappings). </li>
<li>Composite bundles child members (jawr.[type].bundle.[name].child.names).</li>
<li>Custom postprocessors (jawr.custom.postprocessors.names).</li>
<li>Generators (jawr.custom.generators). </li>
</ul>
<p>All the other properties will simply be overwritten. </p>
</div>
<div class="section"><h3>Documenting your configuration</h3>
<p>Once you have Jawr setup this way, the best thing you can do is to document how to use Jawr, and to specify which bundles you are using and how to augment them, in order to get the most out of Jawr usage. </p>
</div>
<div class="section"><h3>Replicating the tag library behavior </h3>
<p>If your framework has anything other than JSP or JSF as the HTML rendering system, then you won't be able to use the tag libraries that Jawr provides. Luckily, it is quite easy to replicate the behavior using the same API used by the taglib. The only functional requirement is to have access to an HttpServletRequest instance and to the current ServletContext when generating the output. If you have a request and access to the ServletContext, Jawr will be able to generate the HTML for you. </p>
<p>Note that you can get the ServletContext using request.getSession().getServletContext(), but this may not always be desirable since it grants the request a session id. </p>
<p>So, if you are ready to get your hands dirty, first be sure you know how the tag libraries work and the parameters they receive so you understand the APIs described below. The component which generates the output is an instance of the BundleRenderer interface; Jawr provides two implementations of this interface. Obviously there's one to render script tags and another to render CSS link tags. The renderers are: </p>
<div class="source"><pre>net.jawr.web.resource.bundle.renderer.JavascriptHTMLBundleLinkRenderer
net.jawr.web.resource.bundle.renderer.CSSHTMLBundleLinkRenderer</pre>
</div>
<p>The constructor of both classes requires an instance of a ResourceBundlesHandler component, which you will get from the ServletContext instance using one of two keys, each belonging to a resource type: </p>
<div class="source"><pre>ResourceBundlesHandler rsHandler = (ResourceBundlesHandler) 
        servletContext.getAttribute(ResourceBundlesHandler.JS_CONTEXT_ATTRIBUTE);</pre>
</div>
<p>or: </p>
<div class="source"><pre>ResourceBundlesHandler rsHandler = (ResourceBundlesHandler) 
        servletContext.getAttribute(ResourceBundlesHandler.CSS_CONTEXT_ATTRIBUTE);</pre>
</div>
<p>These ResourceBundlesHandler are created by Jawr during the server startup procedure and set as context attributes using the string keys shown above. If any of these are null, it means that something went wrong while Jawr was initializing. Once you have this reference, it is easy to create an instance of the renderers: </p>
<div class="source"><pre>BundleRenderer myJsRenderer = new JavascriptHTMLBundleLinkRenderer(rsHandler, true); 
BundleRenderer myCSSRenderer = new CSSHTMLBundleLinkRenderer(rsHandler, true, &quot;screen&quot;);</pre>
</div>
<p>As you noticed, the constructors receive additional parameters: a boolean and, in the case of the CSS renderer, a String. The boolean corresponds to the tag library parameter 'useRandomParam', and the string (which may be null) is the 'media' param for the CSS tag. Refer to the taglib docs for further explanation of what these do. </p>
<p>Once you have a proper instance of BundleRenderer, there is just one method to invoke, so the only thing left to do is to gather the required parameters and make the call. Let's review the API: </p>
<div class="source"><pre>public void renderBundleLinks(  String requestedPath, 
                                BundleRendererContext bundleRendererCtx,
                                Writer out ) throws IOException;</pre>
</div>
<p>The parameters represent the following data: </p>
<ul><li><b>requestedPath</b> corresponds to the taglib's <b>src</b> attribute, so it may be a bundle id or the path to a bundle member. </li>
<li><b>bundleRendererCtx</b> the context of the renderer. To obtain a BundleRendererContext, you could use the following utility method :<div class="source"><pre>BundleRendererContext ctx = RendererRequestUtils.getBundleRendererContext(request, renderer);</pre>
</div>
<p>This object contains :</p>
<ul><li><b>contextPath</b> is obviously the request context path, as retrieved from request.getContextPath(). </li>
<li><b>variantKey</b> is used for the i18n scripts. To retrieve this you need to perform a somewhat long call using the ResourceBundlesHandler instance you retrieved from the servlet context: <div class="source"><pre>String variantKey = rsHandler.getConfig().getLocaleResolver().resolveLocaleCode(request);</pre>
</div>
</li>
<li><b>includedBundles</b> is a Set which holds a log of written tags during the request so that no tag is written out twice. You don't actually need to handle its creation or to hold a reference. Instead rely on a utility method that handles everything: <div class="source"><pre>Set includedBundles = RendererRequestUtils.getAddedBundlesLog(request);</pre>
</div>
</li>
<li><b>useGzip</b> determines wether to use the gzip compressed version of the scripts, based on Jawr configuration and on the request headers. Again, a utility method will take care of everything. You will need to reuse the ResourceBundlesHandler instance once more for this one: <div class="source"><pre>boolean useGzip = RendererRequestUtils.isRequestGzippable(request,rsHandler.getConfig());</pre>
</div>
</li>
</ul>
</li>
<li><b>out</b> is a Writer instance into which the tags will be written. If you just need a string it is perfectly okay to use a StringWriter instance for this purpose. Note that Jawr will not flush nor close this Writer. </li>
</ul>
<p>And this basically covers it. If you want a sample, check out the <b>net.jawr.web.taglib</b> package sources (Jawr sources are available for download and also the SVN is publicly accesible). In this package are all the current implementations of tag libraries used by Jawr (except of course the Grails one), so you can probably get ideas from there. </p>
</div>
</div>

      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">&#169;  
          2009
    
          
  

  
  
  &nbsp;| Last Published: 08/02/2009
  &nbsp;| Version: 3.0
</div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
