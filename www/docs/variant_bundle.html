<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">










<html>
  <head>
    <title>Jawr - Variant bundle</title>
    <style type="text/css" media="all">
      @import url("../css/maven-base.css");
      @import url("../css/maven-theme.css");
      @import url("../css/site.css");
    </style>
    <link rel="stylesheet" href="../css/print.css" type="text/css" media="print" />
        <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />
      </head>
  <body class="composite">
    <!-- TODO: move this into JavaScript to patch the skin
      <div class="xright">  </div>
    -->
    <div id="leftColumn">
      <div id="navcolumn">
             <dl class=navgroup>
        <dt>About</dt>
        <dd><ul>
              
    <li class="none">
              <a href="../servlets/ProjectHome">Home</a>
        </li>
              
    <li class="none">
              <a href="../introduction.html">Introduction</a>
        </li>
              
    <li class="none">
              <a href="../features.html">Features</a>
        </li>
              
    <li class="none">
              <a href="../changes.html">Change history</a>
        </li>
              
    <li class="none">
              <a href="../team.html">The team</a>
        </li>
          </ul></dd>
    </dl>
      <dl class=navgroup>
        <dt>Documentation</dt>
        <dd><ul>
              
    <li class="none">
              <a href="../docs/servlet.html">The Jawr servlet</a>
        </li>
              
    <li class="none">
              <a href="../docs/descriptor_syntax.html">Descriptor syntax</a>
        </li>
              
    <li class="none">
              <a href="../docs/custom_bundles.html">Bundle definition</a>
        </li>
              
    <li class="none">
              <a href="../docs/source_ordering.html">Source order in bundles</a>
        </li>
              
    <li class="none">
              <a href="../docs/global_preprocessors.html">Global preprocessors</a>
        </li>
              
    <li class="none">
              <a href="../docs/postprocessors.html">Postprocessors</a>
        </li>
              
    <li class="none">
              <a href="../docs/generators.html">Generators</a>
        </li>
              
    <li class="none">
              <a href="../docs/advanced_generators.html">Advanced generators</a>
        </li>
              
    <li class="none">
              <a href="../docs/license_files.html">Licenses in resources</a>
        </li>
              
    <li class="none">
              <a href="../docs/taglibs.html">JSP Tag library</a>
        </li>
              
    <li class="none">
              <a href="../docs/plain_html.html">Use in HTML pages</a>
        </li>
              
    <li class="none">
              <a href="../docs/modes.html">Debug and production modes</a>
        </li>
              
    <li class="none">
              <a href="../docs/messages_gen.html">i18n message generator</a>
        </li>
              
    <li class="none">
              <strong>Variant bundles</strong>
        </li>
              
    <li class="none">
              <a href="../docs/illegalBundleRequestHander.html">Jawr strict mode - Illegal bundle request handler</a>
        </li>
              
    <li class="none">
              <a href="../docs/jmx_support.html">JMX Support</a>
        </li>
              
    <li class="none">
              <a href="../docs/bundle_preprocessing.html">Bundle preprocessing</a>
        </li>
              
    <li class="none">
              <a href="../docs/jawr_maven_plugin.html">Jawr Maven plugin</a>
        </li>
              
    <li class="none">
              <a href="../docs/jawr_ant_task.html">Jawr Ant task</a>
        </li>
          </ul></dd>
    </dl>
      <dl class=navgroup>
        <dt>Integration</dt>
        <dd><ul>
              
    <li class="none">
              <a href="../integration/augmenter.html">Add Jawr to your framework</a>
        </li>
              
    <li class="none">
              <a href="../integration/spring.html">Spring MVC</a>
        </li>
              
    <li class="none">
              <a href="../integration/facelets.html">Facelets Tag library</a>
        </li>
              
    <li class="none">
              <a href="../integration/wicket.html">Wicket</a>
        </li>
              
    <li class="none">
              <a href="../integration/grails.html">Grails plugin</a>
        </li>
              
    <li class="none">
              <a href="../integration/dwr.html">DWR</a>
        </li>
              
    <li class="none">
              <a href="../integration/validator.html">Commons Validator - Struts</a>
        </li>
          </ul></dd>
    </dl>
      <dl class=navgroup>
        <dt>Tutorials</dt>
        <dd><ul>
              
    <li class="none">
              <a href="../tutorials/quickstart.html">Quick start</a>
        </li>
              
    <li class="none">
              <a href="../tutorials/howToUseJawrToServeImage.html">How to use Jawr to serve image resources</a>
        </li>
              
    <li class="none">
              <a href="../tutorials/howToUseJawrCssSkin.html">How to use Jawr to generate CSS skin</a>
        </li>
              
    <li class="none">
              <a href="../tutorials/jawrSpriteImage.html">How to generate Image sprites with Jawr</a>
        </li>
              
    <li class="none">
              <a href="../tutorials/howToUseJawrToGenerateBase64Image.html">How to generate base64 images in CSS with Jawr</a>
        </li>
              
    <li class="none">
              <a href="../tutorials/faq_howto.html">FAQ-Howto</a>
        </li>
              
    <li class="none">
              <a href="../tutorials/libraries.html">Using popular libraries</a>
        </li>
          </ul></dd>
    </dl>
      <dl class=navgroup>
        <dt>API and sources</dt>
        <dd><ul>
              
    <li class="none">
              <a href="../nonav/apidocs/index.html">JavaDocs</a>
        </li>
              
    <li class="none">
              <a href="../nonav/xref/index.html">Source XREF</a>
        </li>
          </ul></dd>
    </dl>
      <dl class=navgroup>
        <dt>Project tools</dt>
        <dd><ul>
              
    <li class="none">
              <a href="../servlets/ProjectHome">Project home</a>
        </li>
              
    <li class="none">
              <a href="../servlets/ProjectMemberList">Membership</a>
        </li>
              
    <li class="none">
              <a href="../servlets/ProjectNewsList">Announcements</a>
        </li>
              
    <li class="none">
              <a href="../servlets/ProjectForumView">Discussion forums</a>
        </li>
              
    <li class="none">
              <a href="../servlets/ProjectMailingListList">Mailing lists</a>
        </li>
              
    <li class="none">
              <a href="../servlets/ProjectDocumentList">Documents & files</a>
        </li>
              
    <li class="none">
              <a href="../source/browse/jawr/">Subversion</a>
        </li>
              
    <li class="none">
              <a href="../servlets/ProjectIssues">Issue tracker</a>
        </li>
          </ul></dd>
    </dl>
        </div>
      <script>
        // replace the java.net project tools with the navigation bar from Maven.
        // also get rid of "Get Involved" thingie too, while we are at it
        var pt = document.getElementById("projecttools");
        var nv = document.getElementById("navcolumn");
        
        while(pt.previousSibling!=null)
          pt.parentNode.removeChild(pt.previousSibling);
        
        pt.parentNode.insertBefore(nv,pt);
        pt.parentNode.removeChild(pt);
      </script>
      <script>
        // kill "description" h3 bar
        var ld = document.getElementById("longdescription");
        if(ld!=null) {
          for( n=ld.firstChild; n!=null; n=n.nextSibling ) {
            if(n.nodeType==1 && n.innerHTML=="Description" ) {
              n.parentNode.removeChild(n);
              break;
            }
          }
        }
      </script>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <div class="section"><h2>Variant bundle</h2>
<p>One of the key features of Jawr is its ability to bundle resources and to provide variation of the same bundle depending on the user request.<br />
A good example of variant bundle is the locale variant bundle generated by the <b>i18n messages script generator</b> (Full documentation of the message generator is <a href="./messages_gen.html">here</a>). These bundles have different content depending on the user locale.</p>
<p>So a variant bundle is a bundle which can have different content depending on the user request (cookie, parameter, browser type...). Jawr provides 2 ways for the user to define variant bundles using the public Jawr API :</p>
<ul><li>Generators</li>
<li>PostProcessors</li>
</ul>
<div class="section"><h3>Bundle variant map</h3>
<p>The main idea to understand is how variants are defined for a bundle. In Jawr, we are using a map of variants for a bundle. This map has as key the type of variant (locale, skin, browser, ...). The value associated is a <b>VariantKeySet</b>. A <b>VariantSet</b> is an object containing the set of values available for a defined variant type, and it contains also the default variant value to use.<br />
I will discuss later about the default value strategy. For the rest of the document, I will notate the VariantSet content as [ <b>&quot;defaultValue&quot;</b>, &quot;value1&quot;, &quot;value2&quot; ].<br />
So here the VariantSet contains defaultValue, value1 and value2 and the value in bold is the default value.</p>
<p>To be clearer, we will take an example of a bundle name &quot;bundle1.js&quot;, which has 2 variant types: locale and browser.<br />
In the following example, we have defined the default value as empty but we could have set it to any value of the variant set.</p>
<table class="bodyTable"><tbody><tr class="a"><td align="left"><b>Variant type</b></td>
<td align="left"><b>Variant set</b></td>
<td align="left"><b>Default variant</b></td>
</tr>
<tr class="b"><td align="left">locale<br />
browser</td>
<td align="left">'','fr','en_US'<br />
'','IE6','IE7'</td>
<td align="left">''<br />
''</td>
</tr>
</tbody>
</table>
<p>In this example, the bundle &quot;bundle1&quot; will have 9 variant combinations :</p>
<table class="bodyTable"><tbody><tr class="a"><td align="left"><b>Locale variant</b></td>
<td align="left"><b>Browser variant</b></td>
<td align="left"><b>Variant suffix</b></td>
</tr>
<tr class="b"><td align="left">''<br />
''<br />
''<br />
'fr'<br />
'fr'<br />
'fr'<br />
'en_US'<br />
'en_US'<br />
'en_US'</td>
<td align="left">''<br />
'IE6'<br />
'IE7'<br />
''<br />
'IE6'<br />
'IE7'<br />
''<br />
'IE6'<br />
'IE7'</td>
<td align="left">'@@'<br />
'@@IE6'<br />
'@@IE7'<br />
'@fr@'<br />
'@fr@IE6'<br />
'@fr@IE7'<br />
'@en_US@'<br />
'@en_US@IE6'<br />
'@en_US@IE7'</td>
</tr>
</tbody>
</table>
<p>It is important to understand that a bundle is defined with a map of variant, but for a specific request, there will be in one and only one combination of the variant bundle which will match.</p>
<p>You should also note that Jawr uses <b>&quot;@&quot;</b> as separator for variant values. The variant suffix will be appended to the variant bundle name to distinguish the variants of a bundle.</p>
<ul><li>Variant map concatenation<p>The variant maps can be concatenated. Here are the rules for the concatenation: If the variant map variantMap2 is concatenated to variantMap1. - For each variant type of variant map 2, we will check that the variant type exists in variantMap1. If it doesn't exist we create a new entry in the result map containing as key the variantType and as value the variantSet.</p>
<p>If it exist, we concatenate the VariantSets. The values of the variant sets are concatenated, but if the 2 VariantSets have different default values an exception is thrown, because Jaw is not able to define what is the default value to use for this VariantSet. </p>
</li>
</ul>
<table class="bodyTable"><tbody><tr class="a"><th align="left"><b>VariantMap1</b></th>
<th align="left"><b>VariantMap2</b></th>
<th align="left"><b>Concatenation result</b></th>
</tr>
<tr class="b"><td align="left">['locale' : [<b>''</b>, 'en_US' ]]<br />
['locale' : [<b>''</b>, 'en_US' ]]<br />
['locale' : [<b>''</b>, 'en_US' ]; ['browser' : <b>''</b>, 'IE7']]<br />
['locale' : [<b>''</b>, 'en_US' ]; ['browser' : <b>'IE6'</b>, 'IE7']]</td>
<td align="left">[]<br />
['browser' : [<b>''</b>, 'IE6' ]]<br />
['browser' : [<b>''</b>, 'IE6' ]]<br />
['browser' : [<b>''</b>, 'IE6' ]]</td>
<td align="left">['locale' : [<b>''</b>, 'en_US' ]]<br />
['locale' : [<b>''</b>, 'en_US' ]; 'browser' : [<b>''</b>, 'IE6' ]]<br />
['locale' : [<b>''</b>, 'en_US' ]; 'browser' : [<b>''</b>, 'IE6', 'IE7' ]]<br />
An exception is thrown. The default values are not the same.</td>
</tr>
</tbody>
</table>
</div>
<div class="section"><h3>Variant bundle and Generators</h3>
<p>Like for the MessageResourceGenerator, you can define your own generator which will can have different variant depending on some context. To define a generator, which is able to generate variant content, the generator must implement the interface <i>net.jawr.web.resource.bundle.generator.variant.VariantResourceGenerator</i>.</p>
<img src="../images/variants/variantBundleGenerator.jpg" alt="Variant Bundle generator class diagram" /><p>This interface defines one method which is :</p>
<div class="source"><pre>    
        /**
         * Returns the map of available variant for a resource.
         * The key of the map is the type of variant (for ex: locale, skin...)
         * The values associated are the list of variant for the type. 
         * @param resource the resource name
         * @return the map of available variant for a resource 
         */
        Map getAvailableVariants(String resource);</pre>
</div>
<p>So this method defines the map of variants available for a specific resource. For the returned map of variants, the key is the variant type, and the value is the VariantSet.</p>
<p>So the bundle will be able to initialize the available variants from the generator defined in the mapping. For instance, if you have a bundle whose the mapping is define like this :</p>
<div class="source"><pre>        jawr.css.bundle.myBundle.id=/myBundle.css
        jawr.css.bundle.myBundle.mappings=/css/tree.css,myVariantGen1:/font.css,myVariantGen2:/panel.css</pre>
</div>
<p>If <i>myVariantGen1</i> and <i>myVariantGen2</i> are some custom variant generators, the variant map of the bundle will be the concatenation of the variant map of each bundle.<br />
To be clear, if the variant map for the resource <i>myVariantGen1:/font.css</i> is : [ 'locale' : [<b>''</b>, 'fr_FR']] <br />
And the variant map for the resource <i>myVariantGen2:/panel.css</i> is : [ 'browser' : [<b>''</b>, 'IE6']], <br />
then the variant map for the bundle will be [ 'locale' : [<b>''</b>, 'fr_FR']; 'browser' : [<b>''</b>, 'IE6']]. <br />
For more detail about the variant map concatenation, please take a look to the dedicated section.</p>
</div>
<div class="section"><h3>Variant bundle and Postprocessors</h3>
<p>Jawr allows you to define variant through the post processor also.<br />
To define if a bundle has some variants generated by the postprocessor, Jawr calls the postprocessor with a flag on the postprocess context, to say that it's searching for the bundle variant.<br />
If no variants is define, the Jawr continues as usual. If the postprocessor set some variants in the bundle variant, in that case, Jawr will reprocess the bundle with all the variants.</p>
<p>To be able to handle the variants definition by the postprocessors, 3 methods have been added to the BundleProcessingStatus class.</p>
<div class="source"><pre>        /**
         * Returns true if we are searching for post processor variants.
         * @return true if we are searching for post processor variants.
         */
        public boolean isSearchingPostProcessorVariants();
        
        /**
         * Add a post process variant
         * @param variantType the variant type
         * @param variantSet the variant set
         */
        public void adPostProcessVariant(String variantType, VariantSet variantSet);
        
        /**
         * Add a post process variant
         * @param variantType the variant type
         * @param variantSet the variant set
         */
        public void adPostProcessVariant(Map variants);
        </pre>
</div>
<img src="../images/variants/postProcessorVariants.sqd.jpg" alt="Bundle post processing sequence diagram" /><p>The sequence diagram above gives an overview of what happens when the postprocessor defines some postprocessor variants.</p>
<p>The ResourceBundleHandler, which is responsible of creating the different bundles at server startup, iterates through each bundle.</p>
<ul><li>The ResourceBundleHandler initializes the BundleProcessingStatus and sets the flag indicating that we are searching for postprocessor variant.</li>
<li>Then the ResourceBundleHandler iterates on every variant configuration of the bundle</li>
<li>The ResourceBundleHandler calls the postprocessors with the current variant configuration.</li>
<li>The postprocessor adds postprocessor variants to the BundleProcessingStatus.</li>
<li>Then the ResourceBundleHandler checks if the are some postprocessor variants in the BundleProcessingStatus.<ul><li>If it's not the case, it will create the postprocessed files of the bundle.</li>
</ul>
</li>
<li>If there are some postprocessor variants, it concatenates the bundle variants with the variants found during the postprocessing.</li>
<li>The ResourceBundleHandler updates the BundleProcessingStatus to set the postprocessor variant search flag to false.</li>
<li>Then it reprocesses the bundle with the new variant combinations.</li>
</ul>
</div>
<div class="section"><h3>Variant resolver</h3>
<p>As we have seen, Jawr is able to generate different bundle contents depending on a specific variant context.<br />
The role of the VariantResolver is to define for a request, what is the current variant context.<br />
You can only define <b>one</b> VariantResolver for a specific type.<br />
Here is the list of methods to be implemented by a VariantResolver. </p>
<div class="source"><pre>        
        /**
         * Resolves the variant to use for the user associated to a request.
         * @param request the request
         * @return A string identifying the variant.
         */
        String getVariantType();

        /**
         * Resolves the variant to use for the user associated to a request.
         * @param request the request
         * @return A string identifying the variant.
         */
        String resolveVariant(HttpServletRequest request); 
        
        /**
         * Returns the value to use for the variant from the list of variants available
         * @param variant the value of the variant
         * @param variantSet the available variantSet 
         * @return the value to use for the variant
         */
        String getAvailableVariant(String variant, VariantSet variantSet);              </pre>
</div>
<ul><li>The method <b>getVariantType</b> returns the type of variant that the resolver is responsible for. </li>
<li>The method <b>resolveVariant</b> returns the value of the current variant for the request. It can take any information in the request (header, cookie, parameter) to define the current variant.</li>
<li>The method <b>getAvailableVariant</b> returns the value of the variant from the current value and from the available variant set.</li>
</ul>
<p>The Variant resolver is responsible of the default variant strategy. This means that the variant resolver is responsible to define what is the value to use if the variant doesn't exists in the VariantSet. If the VariantResolver doesn't find a suitable variant, it <b>must</b> returns the default variant.</p>
<p>To register your custom variant resolvers, you need to use the following Jawr configuration property :</p>
<table class="bodyTable"><tbody><tr class="a"><td align="left"><b>Property name</b></td>
<td align="left"><b>Type</b></td>
<td align="left"><b>Purpose</b></td>
<td align="left"><b>Default value</b></td>
</tr>
<tr class="b"><td align="left">jawr.custom.resolvers</td>
<td align="left">Comma separated list.</td>
<td align="left">List of all the VariantResolver implementations you want to use.</td>
<td align="left">None</td>
</tr>
</tbody>
</table>
</div>
</div>

      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">&#169;  
          2010
    
          
  

  
  
  &nbsp;| Last Published: 06/28/2010
  &nbsp;| Version: 3.3
</div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
