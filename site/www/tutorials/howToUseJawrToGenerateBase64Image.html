<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">










<html>
  <head>
    <title>Jawr - Tutorial: How to set up Jawr to generate base64 encoded images</title>
    <style type="text/css" media="all">
      @import url("../css/maven-base.css");
      @import url("../css/maven-theme.css");
      @import url("../css/site.css");
    </style>
    <link rel="stylesheet" href="../css/print.css" type="text/css" media="print" />
        <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />
      </head>
  <body class="composite">
    <!-- TODO: move this into JavaScript to patch the skin
      <div class="xright">  </div>
    -->
    <div id="leftColumn">
      <div id="navcolumn">
             <dl class=navgroup>
        <dt>About</dt>
        <dd><ul>
              
    <li class="none">
              <a href="../servlets/ProjectHome">Home</a>
        </li>
              
    <li class="none">
              <a href="../introduction.html">Introduction</a>
        </li>
              
    <li class="none">
              <a href="../features.html">Features</a>
        </li>
              
    <li class="none">
              <a href="../changes.html">Change history</a>
        </li>
              
    <li class="none">
              <a href="../team.html">The team</a>
        </li>
          </ul></dd>
    </dl>
      <dl class=navgroup>
        <dt>Documentation</dt>
        <dd><ul>
              
    <li class="none">
              <a href="../docs/servlet.html">The Jawr servlet</a>
        </li>
              
    <li class="none">
              <a href="../docs/descriptor_syntax.html">Descriptor syntax</a>
        </li>
              
    <li class="none">
              <a href="../docs/custom_bundles.html">Bundle definition</a>
        </li>
              
    <li class="none">
              <a href="../docs/source_ordering.html">Source order in bundles</a>
        </li>
              
    <li class="none">
              <a href="../docs/global_preprocessors.html">Global preprocessors</a>
        </li>
              
    <li class="none">
              <a href="../docs/postprocessors.html">Postprocessors</a>
        </li>
              
    <li class="none">
              <a href="../docs/generators.html">Generators</a>
        </li>
              
    <li class="none">
              <a href="../docs/advanced_generators.html">Advanced generators</a>
        </li>
              
    <li class="none">
              <a href="../docs/license_files.html">Licenses in resources</a>
        </li>
              
    <li class="none">
              <a href="../docs/taglibs.html">JSP Tag library</a>
        </li>
              
    <li class="none">
              <a href="../docs/plain_html.html">Use in HTML pages</a>
        </li>
              
    <li class="none">
              <a href="../docs/modes.html">Debug and production modes</a>
        </li>
              
    <li class="none">
              <a href="../docs/messages_gen.html">i18n message generator</a>
        </li>
              
    <li class="none">
              <a href="../docs/variant_bundle.html">Variant bundles</a>
        </li>
              
    <li class="none">
              <a href="../docs/illegalBundleRequestHander.html">Jawr strict mode - Illegal bundle request handler</a>
        </li>
              
    <li class="none">
              <a href="../docs/jmx_support.html">JMX Support</a>
        </li>
              
    <li class="none">
              <a href="../docs/bundle_preprocessing.html">Bundle preprocessing</a>
        </li>
              
    <li class="none">
              <a href="../docs/jawr_maven_plugin.html">Jawr Maven plugin</a>
        </li>
              
    <li class="none">
              <a href="../docs/jawr_ant_task.html">Jawr Ant task</a>
        </li>
          </ul></dd>
    </dl>
      <dl class=navgroup>
        <dt>Integration</dt>
        <dd><ul>
              
    <li class="none">
              <a href="../integration/augmenter.html">Add Jawr to your framework</a>
        </li>
              
    <li class="none">
              <a href="../integration/spring.html">Spring MVC</a>
        </li>
              
    <li class="none">
              <a href="../integration/facelets.html">Facelets Tag library</a>
        </li>
              
    <li class="none">
              <a href="../integration/wicket.html">Wicket</a>
        </li>
              
    <li class="none">
              <a href="../integration/grails.html">Grails plugin</a>
        </li>
              
    <li class="none">
              <a href="../integration/dwr.html">DWR</a>
        </li>
              
    <li class="none">
              <a href="../integration/validator.html">Commons Validator - Struts</a>
        </li>
          </ul></dd>
    </dl>
      <dl class=navgroup>
        <dt>Tutorials</dt>
        <dd><ul>
              
    <li class="none">
              <a href="../tutorials/quickstart.html">Quick start</a>
        </li>
              
    <li class="none">
              <a href="../tutorials/howToUseJawrToServeImage.html">How to use Jawr to serve image resources</a>
        </li>
              
    <li class="none">
              <a href="../tutorials/howToUseJawrCssSkin.html">How to use Jawr to generate CSS skin</a>
        </li>
              
    <li class="none">
              <a href="../tutorials/jawrSpriteImage.html">How to generate Image sprites with Jawr</a>
        </li>
              
    <li class="none">
              <strong>How to generate base64 images in CSS with Jawr</strong>
        </li>
              
    <li class="none">
              <a href="../tutorials/faq_howto.html">FAQ-Howto</a>
        </li>
              
    <li class="none">
              <a href="../tutorials/libraries.html">Using popular libraries</a>
        </li>
          </ul></dd>
    </dl>
      <dl class=navgroup>
        <dt>API and sources</dt>
        <dd><ul>
              
    <li class="none">
              <a href="../nonav/apidocs/index.html">JavaDocs</a>
        </li>
              
    <li class="none">
              <a href="../nonav/xref/index.html">Source XREF</a>
        </li>
          </ul></dd>
    </dl>
      <dl class=navgroup>
        <dt>Project tools</dt>
        <dd><ul>
              
    <li class="none">
              <a href="../servlets/ProjectHome">Project home</a>
        </li>
              
    <li class="none">
              <a href="../servlets/ProjectMemberList">Membership</a>
        </li>
              
    <li class="none">
              <a href="../servlets/ProjectNewsList">Announcements</a>
        </li>
              
    <li class="none">
              <a href="../servlets/ProjectForumView">Discussion forums</a>
        </li>
              
    <li class="none">
              <a href="../servlets/ProjectMailingListList">Mailing lists</a>
        </li>
              
    <li class="none">
              <a href="../servlets/ProjectDocumentList">Documents & files</a>
        </li>
              
    <li class="none">
              <a href="../source/browse/jawr/">Subversion</a>
        </li>
              
    <li class="none">
              <a href="../servlets/ProjectIssues">Issue tracker</a>
        </li>
          </ul></dd>
    </dl>
        </div>
      <script>
        // replace the java.net project tools with the navigation bar from Maven.
        // also get rid of "Get Involved" thingie too, while we are at it
        var pt = document.getElementById("projecttools");
        var nv = document.getElementById("navcolumn");
        
        while(pt.previousSibling!=null)
          pt.parentNode.removeChild(pt.previousSibling);
        
        pt.parentNode.insertBefore(nv,pt);
        pt.parentNode.removeChild(pt);
      </script>
      <script>
        // kill "description" h3 bar
        var ld = document.getElementById("longdescription");
        if(ld!=null) {
          for( n=ld.firstChild; n!=null; n=n.nextSibling ) {
            if(n.nodeType==1 && n.innerHTML=="Description" ) {
              n.parentNode.removeChild(n);
              break;
            }
          }
        }
      </script>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <div class="section"><h2>How to set up Jawr to generate base64 encoded images</h2>
<ul><li>Overview<p>The goal of this tutorial is to explain how to set up Jawr to generate base64 encoded images in the CSS bundles.<br />
As you know, one of the main rules to increase performance in your web application is to reduce the number of HTTP requests.<br />
One of the way to achieve this is to create image sprites, which combines multiple images in a single image. Jawr already provides a way to handle this case. Please take a look at the <a href="http://jawr.java.net/tutorials/jawrSpriteImage.html" class="externalLink"> Jawr sprite documentation</a>.<br />
So, with sprite all the reference of the images defined in your CSS will point to one or a few sprites, which will reduce the number of HTTP requests.<br />
There is another way to reduce the number of HTTP requests by encoding the content of the images in base64.<br />
It means that in you generated bundle, the URL references to the image will be replaced by the content of your images.<br />
So your images will be embedded in your CSS. This will increase the size of your CSS files, but will reduce drastically the number of HTTP requests, as there will be no HTTP request required for your images.</p>
<p>Here is an example of the base64 encoding of a CSS image reference:</p>
<div class="source"><pre>        background-image:url(&quot;../../images/logo.png&quot;);</pre>
</div>
<p>Will be transformed like this : </p>
<div class="source"><pre>        background-image:url(&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA...AAElFTkSuQmCC&quot;);</pre>
</div>
<p>So here, the content of the image is set directly in the CSS file.<br />
If we take a look at the generated content, we have:</p>
<ul><li>data - the name of the scheme</li>
<li>image/png - the content type</li>
<li>base64 - the type of encoding used to encode the data</li>
<li>iVBORw0KGgo.....lFTkSuQmCC - the encoded image content </li>
</ul>
</li>
<li>MHTML to the rescue for IE6 and IE7<p>The base64 encoded resources is handled by all major browser except for IE6 and IE7, but fortunately there is a workaround for this, which is the use of MHTML references.</p>
<p>MHTML stands for MIME HTML. It's a file format which allows you to combine multiple contents like images in one file.</p>
<p>So for these browsers, instead of using the data URI, we will use MHTML references. Here is an example of MHTML use in a CSS file :</p>
<div class="source"><pre>
/*
Content-Type: multipart/related; boundary=&quot;_ANY_SEPARATOR&quot;

--_ANY_SEPARATOR
Content-Type:image/png
Content-Location:logo
Content-Transfer-Encoding:base64

iVBORw0KGgoAAAANSUhEUgAAA...AAElFTkSuQmCC
*/

#logo {
  background-image: url(mhtml:http://www.mycomp.com/css/home.css!logo);
}
</pre>
</div>
<p>Here we can see that the MHTML part is set at the top of the file in a commented section.<br />
In the first line, we define the boundary used to separate the declaration of each resource.<br />
Then for each resource, we have some information: * Content-Type - the content type * Content-Transfer-Encoding - the encoding used for this resource. * Content-Location - the property which will allow us to reference this particular resource in the CSS file</p>
<p>If we take a look at the image URL, we have:</p>
<ul><li>mhtml - the name of the scheme</li>
<li>http://www.mycomp.com/css/home.css - the <b>absolute</b> URL of the current CSS</li>
<li>! - a separator</li>
<li>logo - the identifier of our resource in the MHTML part.</li>
</ul>
<p>As we are using absolute URL, Jawr will generate a bundle version for HTTP requests and another one for HTTPS ones. Otherwise IE will raise an warning saying that you have SSL and non SSL content in your page. </p>
</li>
<li>How Jawr handles the absolute URL for MHTML references<p>As we've seen, we must use absolute URL to reference the current CSS which contains the MHTML content. As you know, Jawr generates the bundle at server startup or at build time. <br />
At this stage, Jawr doesn't know the application absolute URL. So Jawr will use a placeholder named <b><a name="JAWR_BUNDLE_PATH">JAWR_BUNDLE_PATH</a></b> in the generated bundle.</p>
<ul><li>For bundles generated at server startup<p>The resolution of the absolute path will be done at <b>runtime</b> for the first request, then it will be put in cache.</p>
</li>
<li>For bundles generated at build time<p>When you generate the Jawr bundles at build time, if you have defined absolute paths for the following properties :</p>
<ul><li><b>jawr.url.contextpath.override</b> : The context path of the application for HTTP</li>
<li><b>jawr.url.contextpath.ssl.override</b> : The context path of the application for HTTPS</li>
</ul>
<p>The values of these properties will be used to reference the absolute path of the CSS bundles.\</p>
<p>Otherwise Jawr will set the reference to the CSS bundles and will let a place holder for the web application URL.</p>
<div class="source"><pre>#logo {
  background-image: url(mhtml:http://{WEBAPP_URL}/gzip_a08d115cf05a5ef92f289b0a7510057f.ie6@/css/home.css!logo);
}</pre>
</div>
<p>You will have to process the content of these bundles to replace <b><a name="WEBAPP_URL">WEBAPP_URL</a></b> by the right web application URL.</p>
</li>
</ul>
</li>
</ul>
<div class="section"><h3>Set up Jawr in your project</h3>
<p>Please check the &quot;quickstart&quot; tutorial for the instruction about Jawr installation in your project.</p>
</div>
<div class="section"><h3>Jawr configuration file</h3>
<p>Since version 3.3, Jawr is able to generate variant bundles from postprocessors. This means that by just setting the correct postprocessor in your bundle, Jawr will generate the content of the CSS for the different browsers.</p>
<p>The id of the postprocessor to use is <b>base64ImageEncoder</b>. <br />
There are 3 properties related to the base64 encoding available in the Jawr configuration :</p>
<table class="bodyTable"><tbody><tr class="a"><td align="left"><b>Property name</b></td>
<td align="left"><b>Type</b></td>
<td align="left"><b>Purpose</b></td>
<td align="left"><b>Default value</b></td>
</tr>
<tr class="b"><td align="left">jawr.css.postprocessor.base64ImageEncoder.encode.by.default</td>
<td align="left">Boolean</td>
<td align="left">Enable/disable the base64 image encoding by default</td>
<td align="left">true</td>
</tr>
<tr class="a"><td align="left">jawr.css.postprocessor.base64ImageEncoder.maxFileLength</td>
<td align="left">Integer</td>
<td align="left">The maximum size of the image to encode in base64 in bytes.</td>
<td align="left">30000</td>
</tr>
<tr class="b"><td align="left">jawr.css.postprocessor.base64ImageEncoder.encode.sprite</td>
<td align="left">Boolean</td>
<td align="left">Enable/disable the base64 image encode on generated sprite image.</td>
<td align="left">False</td>
</tr>
</tbody>
</table>
<ul><li>The property <b>jawr.css.postprocessor.base64ImageEncoder.encode.by.default</b> will define if the postprocessor should encode the CSS image in base64 by default or not. If the <b>jawr.css.postprocessor.base64ImageEncoder.encode.by.default</b> is set to <b>true</b>, by default all the CSS images will be encoded, except if the are followed by the annotation : <b>jawr:base64-skip</b><div class="source"><pre>        .style1 {
                background: url('../img/img1.png') ; 
                height : 20px;
        }
        .style2 {
                background: url('../img/img2.png') ; /** jawr:base64-skip */
                height : 20px;
        }</pre>
</div>
<p>In this example, if <b>jawr.css.postprocessor.base64ImageEncoder.encode.by.default</b> is set to <b>true</b>, only the first image URL will be encoded, the second one will be skipped.</p>
<p>If the <b>jawr.css.postprocessor.base64ImageEncoder.encode.by.default</b> is set to <b>false</b>, by default all the CSS images will be encoded, except if the are followed by the annotation : <b>jawr:base64</b></p>
<div class="source"><pre>        .style1 {
                background: url('../img/img1.png') ; 
                height : 20px;
        }
        .style2 {
                background: url('../img/img2.png') ; /** jawr:base64 */
                height : 20px;
        }</pre>
</div>
<p>In this example, if <b>jawr.css.postprocessor.base64ImageEncoder.encode.by.default</b> is set to <b>false</b>, only the second image URL will be encoded, the first one will be skipped.</p>
</li>
<li>The property <b>jawr.css.postprocessor.base64ImageEncoder.maxFileLength</b> will define the maximum image file size allowed to encode the image. If an image has a size greater than the <i>maxFileLength</i>&gt; property, the post processor will not encode this image. <br />
You should be aware that there is a limitation in IE8, which is not able to handle base64 encoded image which are greater than 32Kb.</li>
<li>The property <b>jawr.css.postprocessor.base64ImageEncoder.encode.sprite</b> defines if the post processor must encode sprite images generated by Jawr using Smartsprites or not.</li>
</ul>
<p>In our example, we will define our bundle like this :</p>
<div class="source"><pre>        jawr.css.bundle.base64Bundle.id=/css/base64Bundle.css
        jawr.css.bundle.skinnedBundle.mappings=/css/one.css
        jawr.css.bundle.base64Bundle.bundlepostprocessors=cssminify,base64ImageEncoder
        jawr.css.bundle.base64Bundle.filepostprocessors=base64ImageEncoder</pre>
</div>
<p><b>Warning:</b><br />
You should noticed that we have set the <b>CSS minifier</b> before our <b>base64ImageEncoder</b>. We use this configuration because the CSS minifier would have removed the MHTML part which in comment.</p>
<p>It is also important to set the base64ImageEncoder as a <b>bundle post processor</b> AND as a <b>file post processor</b>, because this post processor needs to prepend the MHTML part to the bundle and also to rewrite the URLs in each file. <br />
So <b>never</b> use this post processor only as a bundle post processor or only as a file post processor.</p>
</div>
<div class="section"><h3>Test the base64 image encoding</h3>
<p>Create an <b>/img</b> directory at the root of your web application and copy 2 <b>png</b> images in it and rename them to <b>img1.png</b> and <b>img2.png</b> . </p>
<p>Write a test CSS file named <b>/css/one.css</b> and add the following content:</p>
<div class="source"><pre>.style1 {
        background: url('../img/img1.png') ;
        height : 20px;
}
.style2 {
        background: url('../img/img2.png') ; /** jawr:base64-skip */
        height : 20px;
}</pre>
</div>
<p>Here you should noticed that we have added an annotation to image reference of <b>/img/img2.png</b> : <b>/** jawr:base64-skip */</b>.<br />
This annotation tells to the <b>base64ImageEncoder</b> to not encode this image in the process but rewrites the URL so it goes through the Jawr image servlet.</p>
<p>Write a test JSP page and add the following content: </p>
<div class="source"><pre>&lt;%@ taglib uri=&quot;http://jawr.net/tags&quot; prefix=&quot;jawr&quot; %&gt;
&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; %&gt;
&lt;html&gt;
&lt;head&gt;
        &lt;jawr:style src=&quot;/css/base64Bundle.css&quot; /&gt;
&lt;/head&gt;
&lt;body&gt;
        &lt;div class=&quot;style1&quot;&gt;&lt;/div&gt;
        &lt;div class=&quot;style2&quot;&gt;&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre>
</div>
<p>Deploy your application to a server. Open the JSP you created with a firefox browser. If you take a look to the content of the CSS bundle, you should find the data URI reference of your image. You can also check with Firebug that there is no extra HTTP rquest made for your image.</p>
<p>Then open the JSP you created with an IE6 or IE7 browser. If you take a look to the content of the CSS bundle, you should find the MHTML part at the top of your bundle.</p>
</div>
</div>

      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">&#169;  
          2010
    
          
  

  
  
  &nbsp;| Last Published: 06/30/2010
  &nbsp;| Version: 3.3.1
</div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
